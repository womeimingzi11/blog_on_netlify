---
title: 'Using R: 我到底在 B 站花了多长时间？'
author: Han Chen
date: '2021-10-10'
slug: []
categories:
  - Analysis
  - R for Everything
  - Case Report
tags:
  - 数据分析
  - Analysis
  - R
  - 爬虫
  - httr
draft: yes
---

<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>


<p>前段段时间受伤卧病在床，难得的闲暇时间，又以躺着不便于学习为由，疯狂娱乐。几乎沉迷 B 站无法自拔，蓦然回首发现好像在小破站花费了不少时间，遂试图总结一番。</p>
<p>B 站似乎并未提供公开的 API 供查询，幸而已有热心网友分享：</p>
<p><a href="https://github.com/SocialSisterYi/bilibili-API-collect">SocialSisterYi/bilibili-API-collect</a></p>
<div id="设置-cookies" class="section level2">
<h2>设置 Cookies</h2>
<p>本以为只要简单的 httr::GET + httr::set_cookies 就能轻松秒杀，然而未曾想过的是，单就第一步设置 cookies 就花费良久。</p>
<p>参考 bilibili-API-collect 项目（下称项目）中<a href="%22https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/other/API_auth.md%22">API认证与鉴权</a>中的说明，访问 B 站的 cookies 需要 DedeUserID、DedeUserID__ckMd5、SESSDATA 以及 bili_jct。</p>
<p>这不难，直接 Chrome + F12 调试模式，Application 选项卡直接查看即可。</p>
<p><img src="https://raw.fastgit.org/womeimingzi11/self-image/main//202110110017317.png" />
然而，这里获取的 SESSDATA 和 bili_jct 是经过转义了的，因此在使用 <code>httr::set_cookies</code> 生成 cookies 时程序默认会再次转译，然后就报错了……就这个问题，我已经在 <a href="https://github.com/r-lib/httr/pull/706">httr 提交了新的 PR</a> 试图解决，至于能不能合并以及什么时候会合并，就不得而知了。</p>
<p>不过既然是要强制转译，那我们就给 <code>httr::set_cookies</code> 提供已经反转译的 cookies 即可。这里要用到 <code>curl::curl_unescape</code>，实际上 <code>httr::set_cookies</code> 就是通过向量化调用 <code>curl::curl_escape</code> 来完成的转换。具体而言，代码如下：</p>
<!-- Code block for demo purpose -->
<pre class="r"><code>library(&quot;httr&quot;)
cookies &lt;-
  httr::set_cookies(
    DedeUserID = rstudioapi::askForPassword(&quot;DedeUserID&quot;),
    DedeUserID__ckMd5 = rstudioapi::askForPassword(&quot;DedeUserID__ckMd5&quot;),
    SESSDATA = curl::curl_unescape(rstudioapi::askForPassword(&quot;SESSDATA&quot;)),
    bili_jct = curl::curl_unescape(rstudioapi::askForPassword(&quot;bili_jct&quot;))
  )</code></pre>
<!-- Evaluated code code block, but no need to be shown -->
<p>在后续的操作中，只要在请求中附上 <code>cookies</code> 即可。</p>
</div>
<div id="获取历史记录" class="section level2">
<h2>获取历史记录</h2>
<pre class="r"><code>library(&quot;jsonlite&quot;)
history_resp &lt;-
httr::GET(url = &quot;http://api.bilibili.com/x/web-interface/history/cursor&quot;, 
          config = cookies,
          query = list(ps = 30))

hitory_content &lt;-
  httr::content(history_resp, type = &quot;text&quot;)</code></pre>
<pre><code>## No encoding supplied: defaulting to UTF-8.</code></pre>
<pre class="r"><code>jsonlite::fromJSON(hitory_content)</code></pre>
<pre><code>## $code
## [1] 0
## 
## $message
## [1] &quot;0&quot;
## 
## $ttl
## [1] 1
## 
## $data
## $data$cursor
## $data$cursor$max
## [1] 455511840
## 
## $data$cursor$view_at
## [1] 1633836096
## 
## $data$cursor$business
## [1] &quot;archive&quot;
## 
## $data$cursor$ps
## [1] 30
## 
## 
## $data$tab
##      type name
## 1 archive 视频
## 2    live 直播
## 3 article 专栏
## 
## $data$list
##                                                                                  title
## 1                                                【B站API】api研究笔记ep1-视频基本信息
## 2                                                        R语言中的Rest API 之plumber包
## 3                                 逛吃全球最大的山姆旗舰店，小伙把后备箱装满花了多少钱
## 4                                                        那天下午我在拍摄间睡了一觉...
## 5                                         使命召唤系列 《 幽灵（西蒙莱利）的前世今生》
## 6     洗碗时在妈妈面前突然吃海绵刷，喝洗洁精！？妈妈真的吓坏了哈哈哈哈哈哈哈哈哈哈哈哈
## 7                在火锅店做吃播时被隔壁桌频繁找茬，差点当场打起来！？吓到的姐姐竟然...
## 8                               韩国淘气弟弟挑衅在上私教课的姐姐, 姐姐究竟能不能坚持!?
## 9                           私人健身教练在弟弟面前公然占姐姐便宜，愤怒的弟弟居然。。。
## 10      淘气儿子竟然把杂草铺满床铺，洁癖妈妈的新家变成猪圈了？！医院的wifi真快呀。。。
## 11                        肌肉山山】家里突然多出了一个弟弟？姐姐都不敢相信自己的眼睛！
## 12                      淘气弟弟在独居姐姐床下偷藏一整天？！这次真的差点被打住院了。。
## 13                             淘气弟弟在姐姐房间偷偷藏下100个闹钟？！姐姐真实反应笑喷
## 14                                                           我 把 亲 姐 姐 薅 秃 了？
## 15                      当着好朋友的面！生吃他的宠物金鱼？！他会原谅我吗哈哈哈哈哈哈哈
## 16                                    突然给暗恋的美女老师送礼物！怎么才能让她接受！？
## 17                                    妈，我有喜欢的女生了！就是你俩交流可能有点困难～
## 18                          28岁韩国小伙，背井离乡来到温州，竟在街头被陌生人暴打。。。
## 19                            极限反杀！假扮成公园里的一棵“树”？竟把男朋友吓到。。。
## 20                                        我要失恋了？韩国亲姐姐当场发飙让我分手。。。
## 21 邋遢女友得知韩国公婆20min后到达中国！要求立刻见面，女友紧张爆表，代入感极强。。。。
## 22                                   发给其他女生的暧昧信息误发给女友了...我该怎么办？
## 23                                                我的朋友不知道相机开着就表白了。。。
## 24                                                              沃夫冈 美食探店¥37？？
## 25                                  红警核弹在金字塔顶端！必须捷足先登先占领科技武器！
## 26                        行尸走肉11-7，生存小队裹尸皮搜刮物资，联邦营地显露人性卑劣！
## 27                              四度拜相，八年执政，安倍晋三的权力之路【历史调研室14】
## 28                                      士为知己者死！文在寅的复仇之路【历史调研室06】
## 29                                              法国最后的英雄：戴高乐【历史调研室20】
## 30                          执掌德国15年，全世界最有权势的女人：默克尔【历史调研室07】
##    long_title
## 1            
## 2            
## 3            
## 4            
## 5            
## 6            
## 7            
## 8            
## 9            
## 10           
## 11           
## 12           
## 13           
## 14           
## 15           
## 16           
## 17           
## 18           
## 19           
## 20           
## 21           
## 22           
## 23           
## 24           
## 25           
## 26           
## 27           
## 28           
## 29           
## 30           
##                                                                           cover
## 1                                                                              
## 2                                                                              
## 3  http://i1.hdslb.com/bfs/archive/2fbf38e65995bccf7aba2cf9befee03f7b4f81bd.jpg
## 4  http://i1.hdslb.com/bfs/archive/8685fb42d808dd966179fd9a82324f6ee62dcc0c.jpg
## 5  http://i0.hdslb.com/bfs/archive/865cd06ad0336f47d95c9c9aca601772a97848fa.jpg
## 6  http://i2.hdslb.com/bfs/archive/f4ab17389b8d3114a50ca74f694466050f39ca70.jpg
## 7  http://i1.hdslb.com/bfs/archive/de7519f2f93d531bcdc3552beef05116884699cf.jpg
## 8  http://i0.hdslb.com/bfs/archive/576ff5a4b4833651e314a511e5ebc872fb89455a.jpg
## 9  http://i1.hdslb.com/bfs/archive/1e0cc4c94f79285fc92274f72eb62ce9a2d4d81a.jpg
## 10 http://i2.hdslb.com/bfs/archive/59b33746f65ede1a71660fe8bcc7f1a7c05f0f0e.jpg
## 11 http://i1.hdslb.com/bfs/archive/5329f04df4817d25d7f412a109fe029948712b2d.jpg
## 12 http://i1.hdslb.com/bfs/archive/b9750ed3044f68389b3f2612660cbfad0f1cf783.jpg
## 13 http://i1.hdslb.com/bfs/archive/c9858264588483199fe9b0d65258e1d68fcd9c4e.jpg
## 14 http://i0.hdslb.com/bfs/archive/14a40fad396b81ac8afa9f4cc1d5e080aeba0f66.jpg
## 15 http://i2.hdslb.com/bfs/archive/c143877a39344e06802f58533de87956795c5630.jpg
## 16 http://i0.hdslb.com/bfs/archive/fe5c7b7f52a4364fe55ccde3f734cea94c8b9736.jpg
## 17 http://i2.hdslb.com/bfs/archive/2768c45ced32f47e448fb653d6c0ecc4e664aae0.jpg
## 18 http://i2.hdslb.com/bfs/archive/54254a222a7811d10e83768fea23f372ae69d2f7.jpg
## 19 http://i1.hdslb.com/bfs/archive/666ca7af0d52467b7edcd6ae91e7ece1b57ba881.jpg
## 20 http://i2.hdslb.com/bfs/archive/b01ff53f0a1d9318a36c176918a353f51a105ee7.jpg
## 21 http://i2.hdslb.com/bfs/archive/bc83d11a4682685f334cd3ec5589259bcb2c1335.jpg
## 22 http://i0.hdslb.com/bfs/archive/17231d5a42cd2eee0e36c42852f62744bbccc7ee.jpg
## 23 http://i2.hdslb.com/bfs/archive/639dc764919c9e298dd9fb33f0857433e3d19708.jpg
## 24 http://i1.hdslb.com/bfs/archive/3f6f816373e1aa68452f33de150c6e8d42646d67.jpg
## 25 http://i1.hdslb.com/bfs/archive/12a6b7509501997dec6529f35c08f6884db5516a.jpg
## 26 http://i0.hdslb.com/bfs/archive/b488991f97c26f23883e0ccdcbc2f77996788dfd.jpg
## 27 http://i0.hdslb.com/bfs/archive/c45a96b993aff963a8ac0fc3de61b5532f6592bd.jpg
## 28 http://i0.hdslb.com/bfs/archive/368fb7e6e71c42002835e54d489905d3e249c874.jpg
## 29 http://i2.hdslb.com/bfs/archive/4a44fc8aa3a060a4c462c6dbfcf426fc8e66d36b.jpg
## 30 http://i1.hdslb.com/bfs/archive/db69cf448a78b2ee10c8aeefb79422f608464eea.jpg
##                                                                           covers
## 1  https://i0.hdslb.com/bfs/article/00497c8df7130f22e5b953694b8931a22d32f133.jpg
## 2  https://i0.hdslb.com/bfs/article/85f913243f056a0e6b39eff951c132cd650d7ac9.jpg
## 3                                                                           NULL
## 4                                                                           NULL
## 5                                                                           NULL
## 6                                                                           NULL
## 7                                                                           NULL
## 8                                                                           NULL
## 9                                                                           NULL
## 10                                                                          NULL
## 11                                                                          NULL
## 12                                                                          NULL
## 13                                                                          NULL
## 14                                                                          NULL
## 15                                                                          NULL
## 16                                                                          NULL
## 17                                                                          NULL
## 18                                                                          NULL
## 19                                                                          NULL
## 20                                                                          NULL
## 21                                                                          NULL
## 22                                                                          NULL
## 23                                                                          NULL
## 24                                                                          NULL
## 25                                                                          NULL
## 26                                                                          NULL
## 27                                                                          NULL
## 28                                                                          NULL
## 29                                                                          NULL
## 30                                                                          NULL
##    uri history.oid history.epid history.bvid history.page history.cid
## 1           207146            0                         0     4815593
## 2          4043639            0                         0           0
## 3        591124684            0 BV1Qq4y1d7pA            1   422802996
## 4        848459398            0 BV1cL4y167yJ            1   421873504
## 5        378435911            0 BV1Lf4y1c72d            1   422629934
## 6         89668938            0 BV1y7411j7VA            1   153153221
## 7         79622814            0 BV19J41167xA            1   136271394
## 8         76138054            0 BV1GJ411m7By            1   130242689
## 9        837678571            0 BV15g4y187nr            1   174723816
## 10       795638493            0 BV1tC4y1H745            1   192770875
## 11        33730471            0 BV1jb411F7mj            1    59054530
## 12        98096611            0 BV12E411c7X5            1   167448073
## 13        78991140            0 BV1FJ411C7qW            1   135176563
## 14       245603330            0 BV1mv411b7Gk            1   265024331
## 15       673086030            0 BV1CU4y1t7VX            1   338794011
## 16       290316102            0 BV1Yf4y1p7j8            1   331638881
## 17       758217477            0 BV1C64y1d7Uj            1   339973647
## 18       504311584            0 BV1eg411M7sT            1   374485697
## 19       334759585            0 BV1WA411w7vg            1   388937518
## 20       420251816            0 BV163411i7vt            1   402075653
## 21       250590960            0 BV1Ev411A71J            1   410256238
## 22       420877218            0 BV1j341117sf            1   419450883
## 23       806027859            0 BV1H34y1S7FP            1   422715702
## 24       975997409            0 BV1744y1x7PK            1   422403985
## 25       591109597            0 BV1oq4y1d7cF            1   422647652
## 26       420971385            0 BV11341117xZ            1   422579731
## 27       457002510            0 BV1H5411b73i            1   236443567
## 28       882939610            0 BV1hK4y1b7TJ            1   185145589
## 29       332146096            0 BV1TA411N7m3            1   313797684
## 30       455511840            0 BV1L541147hi            1   188829166
##                                                    history.part
## 1                                                              
## 2                                                              
## 3  山姆超市的零食真的好吃吗？小伙逛完全球最大的山姆店，钱包空了
## 4                          不得不说这是我自己最喜欢的一个广告了
## 5                  使命召唤系列 《 幽灵（西蒙莱利）的前世今生》
## 6                                                          2555
## 7                                                       C0003_2
## 8                                                 hanniu zuihou
## 9                                                      健身欧巴
## 10                                               妈妈茅草床最终
## 11                                                   P1000429_1
## 12                                                    寄生虫fin
## 13                                                         1122
## 14                                                     姐姐脱发
## 15                                                          123
## 16                                                          522
## 17                                                         7775
## 18                                                          009
## 19                                                           66
## 20                                                           rr
## 21                                                          551
## 22                                                          621
## 23                                                          551
## 24                                                       沃夫冈
## 25                                                     先抢核弹
## 26                                                     行尸11-7
## 27       四度拜相，八年执政，安倍晋三的权力之路【历史调研室14】
## 28                               士为知己者死！文在寅的复仇之路
## 29                       法国最后的英雄：戴高乐【历史调研室20】
## 30                   执掌德国15年，全世界最有权势的女人：默克尔
##    history.business history.dt videos   author_name
## 1      article-list          2      0   社会易姐QwQ
## 2           article          2      0 stone的小石头
## 3           archive          4      1  拜托了小翔哥
## 4           archive          4      1    摸鱼事务所
## 5           archive          4      1      老戴在此
## 6           archive          4      1      肌肉山山
## 7           archive          4      1      肌肉山山
## 8           archive          4      1      肌肉山山
## 9           archive          4      1      肌肉山山
## 10          archive          4      1      肌肉山山
## 11          archive          4      1      肌肉山山
## 12          archive          4      1      肌肉山山
## 13          archive          4      1      肌肉山山
## 14          archive          4      1      肌肉山山
## 15          archive          4      1      肌肉山山
## 16          archive          4      1      肌肉山山
## 17          archive          4      1      肌肉山山
## 18          archive          4      1      肌肉山山
## 19          archive          4      1      肌肉山山
## 20          archive          4      1      肌肉山山
## 21          archive          4      1      肌肉山山
## 22          archive          4      1      肌肉山山
## 23          archive          4      1      肌肉山山
## 24          archive          4      1    真探唐仁杰
## 25          archive          4      1     红警HBK08
## 26          archive          4      1      大熊观影
## 27          archive          2      1    历史调研室
## 28          archive          2      1    历史调研室
## 29          archive          2      1    历史调研室
## 30          archive          2      1    历史调研室
##                                                                  author_face
## 1  http://i0.hdslb.com/bfs/face/aebb2639a0d47f2ce1fec0631f412eaf53d4a0be.jpg
## 2  http://i0.hdslb.com/bfs/face/46b2dc9d4d5c78518fdf45dd9a5873b8ee312ad6.jpg
## 3  http://i0.hdslb.com/bfs/face/e3f34781933482a76d175cafcbf57370288de93e.jpg
## 4  http://i1.hdslb.com/bfs/face/93c8bd776691b3b114b5e06f5c8dff96a28f7c82.jpg
## 5  http://i0.hdslb.com/bfs/face/23e0957755d11f8249df336550e9d2101ab962d4.jpg
## 6  http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 7  http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 8  http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 9  http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 10 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 11 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 12 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 13 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 14 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 15 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 16 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 17 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 18 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 19 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 20 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 21 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 22 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 23 http://i2.hdslb.com/bfs/face/6e5a82548b843ea4196dc62dd6b33f74eb481768.jpg
## 24 http://i1.hdslb.com/bfs/face/f82b7cb6e6b9e2351bb201f668af10b66b4d0d5c.jpg
## 25 http://i0.hdslb.com/bfs/face/66ab5bd4e218aeb663e13b6871b46b2894800416.jpg
## 26 http://i2.hdslb.com/bfs/face/0ef4038977b5314bf15be1d4b5781762038411ba.jpg
## 27 http://i0.hdslb.com/bfs/face/5e687a2a90670e6b8e14b4f635ec38eb99f7e5eb.jpg
## 28 http://i0.hdslb.com/bfs/face/5e687a2a90670e6b8e14b4f635ec38eb99f7e5eb.jpg
## 29 http://i0.hdslb.com/bfs/face/5e687a2a90670e6b8e14b4f635ec38eb99f7e5eb.jpg
## 30 http://i0.hdslb.com/bfs/face/5e687a2a90670e6b8e14b4f635ec38eb99f7e5eb.jpg
##    author_mid    view_at progress badge show_title duration current total
## 1   293793435 1633874905        0  专栏                   0             0
## 2   231068868 1633874873        0  专栏                   0             0
## 3   353539995 1633867560       -1                       609             0
## 4   327757321 1633866943       -1                       156             0
## 5     2142762 1633866771       14                       630             0
## 6   203708804 1633866750       -1                       455             0
## 7   203708804 1633851242       -1                       602             0
## 8   203708804 1633850637       -1                       604             0
## 9   203708804 1633850048       -1                       617             0
## 10  203708804 1633849431      115                       601             0
## 11  203708804 1633849312       -1                       320             0
## 12  203708804 1633849048       -1                       620             0
## 13  203708804 1633848485       -1                       602             0
## 14  203708804 1633847961       -1                       606             0
## 15  203708804 1633847380       -1                       541             0
## 16  203708804 1633846828       82                       508             0
## 17  203708804 1633846771       -1                       506             0
## 18  203708804 1633846325      389                       663             0
## 19  203708804 1633846033      497                       543             0
## 20  203708804 1633845614       -1                       604             0
## 21  203708804 1633845002      502                       507             0
## 22  203708804 1633844502      529                       538             0
## 23  203708804 1633843965       -1                       623             0
## 24  544336675 1633843352       -1                       181             0
## 25 1629347259 1633843162       -1                       877             0
## 26  268819811 1633842218       -1                       619             0
## 27  519872016 1633838541        2                       763             0
## 28  519872016 1633838538        0                       718             0
## 29  519872016 1633837637     1464                      1476             0
## 30  519872016 1633836096      625                       632             0
##    new_desc is_finish is_fav       kid tag_name live_status
## 1                   0      0    207146                    0
## 2                   0      0   4043639                    0
## 3                   0      0 591124684 美食测评           0
## 4                   0      0 848459398     搞笑           0
## 5                   0      0 378435911 单机游戏           0
## 6                   0      0  89668938     搞笑           0
## 7                   0      0  79622814     搞笑           0
## 8                   0      0  76138054     搞笑           0
## 9                   0      0 837678571     搞笑           0
## 10                  0      0 795638493     搞笑           0
## 11                  0      0  33730471     搞笑           0
## 12                  0      0  98096611     搞笑           0
## 13                  0      0  78991140     搞笑           0
## 14                  0      0 245603330     搞笑           0
## 15                  0      0 673086030     搞笑           0
## 16                  0      0 290316102     搞笑           0
## 17                  0      0 758217477     搞笑           0
## 18                  0      0 504311584     搞笑           0
## 19                  0      0 334759585     搞笑           0
## 20                  0      0 420251816     搞笑           0
## 21                  0      0 250590960     搞笑           0
## 22                  0      0 420877218     搞笑           0
## 23                  0      0 806027859     搞笑           0
## 24                  0      0 975997409 美食侦探           0
## 25                  0      0 591109597 单机游戏           0
## 26                  0      0 420971385 影视杂谈           0
## 27                  0      0 457002510 人文历史           0
## 28                  0      0 882939610 人文历史           0
## 29                  0      0 332146096 人文历史           0
## 30                  0      0 455511840 人文历史           0</code></pre>
<p>欢迎通过<a href="mailto://chenhan28@gmail.com">邮箱</a>，<a href="https://weibo.com/womeimingzi11">微博</a>, <a href="https://twitter.com/chenhan1992">Twitter</a>以及<a href="https://www.zhihu.com/people/womeimingzi">知乎</a>与我联系。也欢迎关注<a href="https://blog.washman.top/">我的博客</a>。如果能对<a href="https://github.com/womeimingzi11">我的 Github</a> 感兴趣，就再欢迎不过啦！</p>
</div>
