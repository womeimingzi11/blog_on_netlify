<!DOCTYPE html>
<html lang="zh-cn">
    <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="format-detection" content="telephone=no" />

  <title>
    Using R: 我到底在 B 站花了多长时间？ | 洗衣机的博客
  </title>

  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#ffffff" />

  
  <link
    rel="stylesheet"
    href="https://unpkg.com/modern-normalize@0.6.0/modern-normalize.css"
  />

  
  
  
  
  <link rel="stylesheet" href="https://blog.washman.top/style.min.bd2cee8cbd90a87d0e442d03c16f05be6e30184eb160d1d9013e70e07b8490f4.css" integrity="sha256-vSzujL2QqH0ORC0DwW8Fvm4wGE6xYNHZAT5w4HuEkPQ=" />

  
  
    
  
</head>

    <body>
        <header id="header">
  <div class="header_container">
    <h1 class="sitetitle">
      <a href="https://blog.washman.top/" title="洗衣机的博客">洗衣机的博客</a>
    </h1>
    <nav class="navbar">
      <ul>
        <li><a href="https://blog.washman.top/">Home</a></li>
        
          <li>
            <a href="/about/">
              
              <span>About Me</span>
            </a>
          </li>
        
          <li>
            <a href="/tags/">
              
              <span>Tags</span>
            </a>
          </li>
        
          <li>
            <a href="/post/">
              
              <span>Posts</span>
            </a>
          </li>
        
        <li class="hide-sm"><a href="https://blog.washman.top/index.xml" type="application/rss+xml">RSS</a></li>
      </ul>
    </nav>
  </div>
</header>

        
<section id="main">
  <article class="post content">
    <h2 class="title">Using R: 我到底在 B 站花了多长时间？</h2>
    <div class="post_content">
      
<script src="/rmarkdown-libs/header-attrs/header-attrs.js"></script>
<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<link href="/rmarkdown-libs/datatables-css/datatables-crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/datatables-binding/datatables.js"></script>
<script src="/rmarkdown-libs/jquery/jquery-3.6.0.min.js"></script>
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="/rmarkdown-libs/dt-core/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="/rmarkdown-libs/dt-core/js/jquery.dataTables.min.js"></script>
<link href="/rmarkdown-libs/crosstalk/css/crosstalk.css" rel="stylesheet" />
<script src="/rmarkdown-libs/crosstalk/js/crosstalk.min.js"></script>

<div id="TOC">
<ul>
<li><a href="#设置登陆信息"><span class="toc-section-number">1</span> 设置登陆信息</a></li>
<li><a href="#获取历史记录"><span class="toc-section-number">2</span> 获取历史记录</a></li>
<li><a href="#数据整理"><span class="toc-section-number">3</span> 数据整理</a></li>
<li><a href="#数据可视化"><span class="toc-section-number">4</span> 数据可视化</a>
<ul>
<li><a href="#我到底看了多久的视频"><span class="toc-section-number">4.1</span> 我到底看了多久的视频？</a></li>
<li><a href="#什么时候才会看-b-站"><span class="toc-section-number">4.2</span> 什么时候才会看 B 站？</a></li>
<li><a href="#我看了哪类视频"><span class="toc-section-number">4.3</span> 我看了哪类视频？</a></li>
</ul></li>
</ul>
</div>

<p>前段段时间受伤卧病在床，难得的闲暇时间，又以躺着不便于学习为由，疯狂娱乐。几乎沉迷 B 站无法自拔，蓦然回首发现好像在小破站花费了不少时间，遂试图总结一番。</p>
<p>既然想要总结分析在 B 站的动态，数据获取必然是最重要的，然而 B 站似乎并未提供公开的 API 供查询，幸而已有热心网友分享：</p>
<p><a href="https://github.com/SocialSisterYi/bilibili-API-collect">SocialSisterYi/bilibili-API-collect</a></p>
<p><a href="https://github.com/SocialSisterYi/bilibili-API-collect">SocialSisterYi/bilibili-API-collect</a>（下文简称<strong>项目</strong>），通过对 B 站 Web 端、移动端以及 TV 端等诸多来源的 B 站 API 进行收集整理，汇总了一份较为全面的非官方 API 文档。</p>
<p>本文基于项目，利用 R 语言对笔者在 B 站的历史记录进行分析总结。</p>
<div id="设置登陆信息" class="section level1" number="1">
<h1><span class="header-section-number">1</span> 设置登陆信息</h1>
<p>既然要访问历史记录，毫无疑问需要设置登陆信息。根据项目中的<a href="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/other/API_auth.md">API 认证与鉴权</a>以及<a href="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/login/login_info.md">登录基本信息</a>的说明，首先设置 Cookies 信息，然而本以为只要简单的 httr::GET + httr::set_cookies 就能轻松秒杀，然而未曾想过的是，设置 cookies 就耗时良久。</p>
<p>根据 <a href="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/other/API_auth.md">API 认证与鉴权</a>中的说明，访问 B 站的 cookies 需要 DedeUserID、DedeUserID__ckMd5、SESSDATA 以及 bili_jct。</p>
<p>这不难，直接 Chrome + F12 调试模式，Application 选项卡直接查看即可。</p>
<p><img src="https://raw.fastgit.org/womeimingzi11/self-image/main//202110110017317.png" />
然而，这里获取的 SESSDATA 和 bili_jct 是经过转义了的，因此在使用 <code>httr::set_cookies</code> 生成 cookies 时程序默认会再次转译，然后就报错了……就这个问题，我已经在 <a href="https://github.com/r-lib/httr/pull/706">httr 提交了新的 PR</a> 试图解决，至于能不能合并以及什么时候会合并，就不得而知了。</p>
<p>不过既然是要强制转译，那我们就给 <code>httr::set_cookies</code> 提供已经反转译的 cookies 即可。这里要用到 <code>curl::curl_unescape</code>，实际上 <code>httr::set_cookies</code> 就是通过向量化调用 <code>curl::curl_escape</code> 来完成的转换。具体而言，代码如下：</p>
<!-- Code block for demo purpose -->
<pre class="r"><code>library(&quot;httr&quot;)
cookies &lt;-
  httr::set_cookies(
    DedeUserID = rstudioapi::askForPassword(&quot;DedeUserID&quot;),
    DedeUserID__ckMd5 = rstudioapi::askForPassword(&quot;DedeUserID__ckMd5&quot;),
    SESSDATA = curl::curl_unescape(rstudioapi::askForPassword(&quot;SESSDATA&quot;)),
    bili_jct = curl::curl_unescape(rstudioapi::askForPassword(&quot;bili_jct&quot;))
  )</code></pre>
<!-- Evaluated code code block, but no need to be shown -->
<p>在后续的操作中，只要在请求中附上 <code>cookies</code> 即可。</p>
</div>
<div id="获取历史记录" class="section level1" number="2">
<h1><span class="header-section-number">2</span> 获取历史记录</h1>
<p>首先是查询历史记录，在<a href="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/history&amp;toview/history.md#%E8%8E%B7%E5%8F%96%E5%85%A8%E9%83%A8%E8%A7%86%E9%A2%91%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%EF%BC%88%E6%97%A7%EF%BC%89">历史记录</a>章节中提供了新/旧两个 API.</p>
<blockquote>
<p><a href="http://api.bilibili.com/x/web-interface/history/cursor" class="uri">http://api.bilibili.com/x/web-interface/history/cursor</a></p>
<p><a href="http://api.bilibili.com/x/v2/history" class="uri">http://api.bilibili.com/x/v2/history</a></p>
</blockquote>
<p>虽然新的 API 可以请求到包括视频、直播和专栏在内的多种观看记录，然而笔者仅从 B 站观看视频，因此旧 API 就足够，其次旧版 API 可以返回更多的历史记录，也特别适合本次案例。</p>
<p>此外，为了获取尽可能多的观看记录，这里还使用 <code>pn</code> 控制历史记录偏移量，pn 每增大一，请求记录就往更久方向移动 300 条。笔者经过实验，发现该案例中最多请求到 <code>pn=4</code>。那么我们就分别执行 4 次请求并合并。其中请求在返回对象的 <code>$data</code> 中。</p>
<pre class="r"><code>library(&quot;jsonlite&quot;)
library(&quot;pillar&quot;)
library(&quot;purrr&quot;)
library(&quot;dplyr&quot;)
library(&quot;tibble&quot;)

pn_ls &lt;-
  c(1:4)

history_resp_ls &lt;-
  map(pn_ls,
      function(pn){
        history_resp &lt;-
          httr::GET(url = 
                      &quot;http://api.bilibili.com/x/v2/history&quot;,
                    config = cookies,
                    query = list(pn = pn))
        
        history_content &lt;-
          httr::content(history_resp, type = &quot;text&quot;)
        
        # The response of GET is a json
        history_from_json &lt;-
          jsonlite::fromJSON(history_content)
        
        # The history records are in `data`
        history_from_json$data
        }
      )

history_tb &lt;-
  reduce(history_resp_ls, bind_rows) %&gt;% 
  as_tibble()

# glimpse(history_tb)
head(history_tb)</code></pre>
<pre><code>## # A tibble: 6 × 37
##         aid videos   tid tname   copyright pic   title pubdate  ctime desc  state
##       &lt;int&gt;  &lt;int&gt; &lt;int&gt; &lt;chr&gt;       &lt;int&gt; &lt;chr&gt; &lt;chr&gt;   &lt;int&gt;  &lt;int&gt; &lt;chr&gt; &lt;int&gt;
## 1 632936267      1   212 美食侦…         1 http… 还是…  1.63e9 1.63e9 &quot;-&quot;       0
## 2 721202142      1   228 人文历…         1 http… 中国…  1.63e9 1.63e9 &quot;移…      0
## 3 378655043      1   176 汽车生…         1 http… 什么…  1.63e9 1.63e9 &quot;诈…      0
## 4 676243719      1    76 美食制…         1 http… 这是…  1.63e9 1.63e9 &quot;日…      0
## 5 758813440      1   138 搞笑            1 http… 太顶…  1.62e9 1.62e9 &quot;吴…      0
## 6 847480646      1    28 原创音…         1 http… “梗…   1.63e9 1.63e9 &quot;引…      0
## # … with 26 more variables: duration &lt;int&gt;, rights &lt;df[,12]&gt;, owner &lt;df[,3]&gt;,
## #   stat &lt;df[,11]&gt;, dynamic &lt;chr&gt;, cid &lt;int&gt;, dimension &lt;df[,3]&gt;,
## #   short_link_v2 &lt;chr&gt;, up_from_v2 &lt;int&gt;, favorite &lt;lgl&gt;, type &lt;int&gt;,
## #   sub_type &lt;int&gt;, device &lt;int&gt;, page &lt;df[,8]&gt;, count &lt;int&gt;, progress &lt;int&gt;,
## #   view_at &lt;int&gt;, kid &lt;int&gt;, business &lt;chr&gt;, redirect_link &lt;chr&gt;, bvid &lt;chr&gt;,
## #   mission_id &lt;int&gt;, season_id &lt;int&gt;, redirect_url &lt;chr&gt;, bangumi &lt;df[,7]&gt;,
## #   cheese &lt;df[,5]&gt;</code></pre>
<pre class="r"><code>summary(history_tb)</code></pre>
<pre><code>##       aid                videos          tid           tname          
##  Min.   :  2599625   Min.   : 1.0   Min.   : 17.0   Length:1200       
##  1st Qu.:336101652   1st Qu.: 1.0   1st Qu.: 31.0   Class :character  
##  Median :587790294   Median : 1.0   Median :138.0   Mode  :character  
##  Mean   :560113126   Mean   : 1.2   Mean   :124.2                     
##  3rd Qu.:763318868   3rd Qu.: 1.0   3rd Qu.:212.0                     
##  Max.   :976237705   Max.   :49.0   Max.   :239.0                     
##                                                                       
##    copyright         pic               title              pubdate         
##  Min.   :1.000   Length:1200        Length:1200        Min.   :1.437e+09  
##  1st Qu.:1.000   Class :character   Class :character   1st Qu.:1.614e+09  
##  Median :1.000   Mode  :character   Mode  :character   Median :1.631e+09  
##  Mean   :1.142                                         Mean   :1.619e+09  
##  3rd Qu.:1.000                                         3rd Qu.:1.632e+09  
##  Max.   :2.000                                         Max.   :1.635e+09  
##                                                                           
##      ctime               desc               state             duration       
##  Min.   :1.497e+09   Length:1200        Min.   :-100.000   Min.   :     9.0  
##  1st Qu.:1.614e+09   Class :character   1st Qu.:   0.000   1st Qu.:   120.0  
##  Median :1.631e+09   Mode  :character   Median :   0.000   Median :   364.0  
##  Mean   :1.620e+09                      Mean   :  -0.755   Mean   :   737.6  
##  3rd Qu.:1.632e+09                      3rd Qu.:   0.000   3rd Qu.:   713.0  
##  Max.   :1.635e+09                      Max.   :   0.000   Max.   :132074.0  
##                                                                              
##       rights.bp           rights.elec        rights.download       rights.movie          rights.pay           rights.hd5        rights.no_reprint     rights.autoplay      rights.ugc_pay     rights.is_cooperation  rights.ugc_pay_preview  rights.no_background
##  Min.   :0            Min.   :0            Min.   :0            Min.   :0            Min.   :0.0000       Min.   :0.0000       Min.   :0.0000000    Min.   :0.0000       Min.   :0            Min.   :0.0000       Min.   :0            Min.   :0                
##  1st Qu.:0            1st Qu.:0            1st Qu.:0            1st Qu.:0            1st Qu.:0.0000       1st Qu.:0.0000       1st Qu.:1.0000000    1st Qu.:1.0000       1st Qu.:0            1st Qu.:0.0000       1st Qu.:0            1st Qu.:0                
##  Median :0            Median :0            Median :0            Median :0            Median :0.0000       Median :0.0000       Median :1.0000000    Median :1.0000       Median :0            Median :0.0000       Median :0            Median :0                
##  Mean   :0            Mean   :0            Mean   :0            Mean   :0            Mean   :0.0025       Mean   :0.4375       Mean   :0.8316667    Mean   :0.9925       Mean   :0            Mean   :0.0375       Mean   :0            Mean   :0                
##  3rd Qu.:0            3rd Qu.:0            3rd Qu.:0            3rd Qu.:0            3rd Qu.:0.0000       3rd Qu.:1.0000       3rd Qu.:1.0000000    3rd Qu.:1.0000       3rd Qu.:0            3rd Qu.:0.0000       3rd Qu.:0            3rd Qu.:0                
##  Max.   :0            Max.   :0            Max.   :0            Max.   :0            Max.   :1.0000       Max.   :1.0000       Max.   :1.0000000    Max.   :1.0000       Max.   :0            Max.   :1.0000       Max.   :0            Max.   :0                
##                                                                                                                                                                                                                                                                  
##       owner.mid             owner.name            owner.face     
##  Min.   :     28457    Length:1200           Length:1200         
##  1st Qu.:  23947287    Class :character      Class :character    
##  Median : 337521240    Mode  :character      Mode  :character    
##  Mean   : 467453220    NA                    NA                  
##  3rd Qu.: 544336675    NA                    NA                  
##  Max.   :2105467274    NA                    NA                  
##                                                                  
##       stat.aid             stat.view          stat.danmaku          stat.reply          stat.favorite          stat.coin           stat.share          stat.now_rank        stat.his_rank          stat.like          stat.dislike    
##  Min.   :  2599625    Min.   :     378     Min.   :     0.00    Min.   :    0.00     Min.   :     0.0     Min.   :     0.0     Min.   :     0.00    Min.   :0            Min.   :  0.0000     Min.   :      0.0    Min.   :0          
##  1st Qu.:336101652    1st Qu.:  142812     1st Qu.:   292.00    1st Qu.:  236.00     1st Qu.:   626.2     1st Qu.:   473.8     1st Qu.:    97.75    1st Qu.:0            1st Qu.:  0.0000     1st Qu.:   5843.8    1st Qu.:0          
##  Median :587790294    Median :  496958     Median :  1145.00    Median :  691.00     Median :  2543.0     Median :  2616.0     Median :   598.00    Median :0            Median :  0.0000     Median :  19623.0    Median :0          
##  Mean   :560113126    Mean   : 1237879     Mean   :  4531.27    Mean   : 1697.03     Mean   : 12988.9     Mean   : 22294.0     Mean   :  4892.27    Mean   :0            Mean   :  6.7825     Mean   :  68178.2    Mean   :0          
##  3rd Qu.:763318868    3rd Qu.: 1451116     3rd Qu.:  4072.50    3rd Qu.: 1827.50     3rd Qu.:  8584.0     3rd Qu.: 13353.0     3rd Qu.:  2610.75    3rd Qu.:0            3rd Qu.:  0.0000     3rd Qu.:  71615.8    3rd Qu.:0          
##  Max.   :976237705    Max.   :26865323     Max.   :175789.00    Max.   :37253.00     Max.   :730496.0     Max.   :774376.0     Max.   :279676.00    Max.   :0            Max.   :819.0000     Max.   :1276872.0    Max.   :0          
##                                                                                                                                                                                                                                       
##    dynamic               cid           
##  Length:1200        Min.   :  4062651  
##  Class :character   1st Qu.:300695667  
##  Mode  :character   Median :401334872  
##                     Mean   :348783941  
##                     3rd Qu.:412164764  
##                     Max.   :428187561  
##                                        
##    dimension.width     dimension.height     dimension.rotate  
##  Min.   : 318.000     Min.   : 240.000     Min.   :0.0000000  
##  1st Qu.:1280.000     1st Qu.:1080.000     1st Qu.:0.0000000  
##  Median :1920.000     Median :1080.000     Median :0.0000000  
##  Mean   :1839.597     Mean   :1231.498     Mean   :0.0016667  
##  3rd Qu.:1920.000     3rd Qu.:1080.000     3rd Qu.:0.0000000  
##  Max.   :4096.000     Max.   :4320.000     Max.   :1.0000000  
##                                                               
##  short_link_v2        up_from_v2     favorite            type       
##  Length:1200        Min.   : 1.00   Mode :logical   Min.   : 3.000  
##  Class :character   1st Qu.: 8.00   FALSE:1167      1st Qu.: 3.000  
##  Mode  :character   Median : 9.00   TRUE :33        Median : 3.000  
##                     Mean   :15.96                   Mean   : 3.012  
##                     3rd Qu.:20.00                   3rd Qu.: 3.000  
##                     Max.   :36.00                   Max.   :10.000  
##                     NA&#39;s   :1000                                    
##     sub_type           device     
##  Min.   :0.00000   Min.   :1.000  
##  1st Qu.:0.00000   1st Qu.:1.000  
##  Median :0.00000   Median :1.000  
##  Mean   :0.01833   Mean   :2.118  
##  3rd Qu.:0.00000   3rd Qu.:4.000  
##  Max.   :7.00000   Max.   :4.000  
##                                   
##                           page.cid                                                   page.page                                                   page.from                                                   page.part                                                 page.duration                                                  page.vid                                                  page.weblink                         page.dimension.width     dimension.height    dimension.rotate 
##  Min.   :  4062651                                           Min.   : 1.000000                                           Length:1200                                                 Length:1200                                                 Min.   :    7.00                                            Length:1200                                                 Length:1200                                                 Min.   : 318.000    Min.   : 240.000    Min.   :0.000000      
##  1st Qu.:300266664                                           1st Qu.: 1.000000                                           Class :character                                            Class :character                                            1st Qu.:  119.00                                            Class :character                                            Class :character                                            1st Qu.:1280.000    1st Qu.:1080.000    1st Qu.:0.000000      
##  Median :401174042                                           Median : 1.000000                                           Mode  :character                                            Mode  :character                                            Median :  340.00                                            Mode  :character                                            Mode  :character                                            Median :1920.000    Median :1080.000    Median :0.000000      
##  Mean   :348207322                                           Mean   : 1.026072                                           NA                                                          NA                                                          Mean   :  487.39                                            NA                                                          NA                                                          Mean   :1838.506    Mean   :1229.653    Mean   :0.001682      
##  3rd Qu.:412109363                                           3rd Qu.: 1.000000                                           NA                                                          NA                                                          3rd Qu.:  694.00                                            NA                                                          NA                                                          3rd Qu.:1920.000    3rd Qu.:1080.000    3rd Qu.:0.000000      
##  Max.   :428187561                                           Max.   :17.000000                                           NA                                                          NA                                                          Max.   :10943.00                                            NA                                                          NA                                                          Max.   :4096.000    Max.   :4320.000    Max.   :1.000000      
##  NA&#39;s   :11                                                  NA&#39;s   :11                                                  NA                                                          NA                                                          NA&#39;s   :11                                                  NA                                                          NA                                                          NA&#39;s   :11          NA&#39;s   :11          NA&#39;s   :11            
##      count           progress         view_at               kid           
##  Min.   : 1.000   Min.   :  -1.0   Min.   :1.630e+09   Min.   :    27040  
##  1st Qu.: 1.000   1st Qu.:  -1.0   1st Qu.:1.632e+09   1st Qu.:335887840  
##  Median : 1.000   Median :   1.0   Median :1.632e+09   Median :587030088  
##  Mean   : 1.201   Mean   : 122.3   Mean   :1.633e+09   Mean   :556435075  
##  3rd Qu.: 1.000   3rd Qu.: 101.2   3rd Qu.:1.633e+09   3rd Qu.:763218471  
##  Max.   :49.000   Max.   :2334.0   Max.   :1.635e+09   Max.   :976237705  
##  NA&#39;s   :8                                                                
##    business         redirect_link          bvid             mission_id    
##  Length:1200        Length:1200        Length:1200        Min.   : 10923  
##  Class :character   Class :character   Class :character   1st Qu.: 28604  
##  Mode  :character   Mode  :character   Mode  :character   Median : 84241  
##                                                           Mean   : 82051  
##                                                           3rd Qu.:122069  
##                                                           Max.   :208463  
##                                                           NA&#39;s   :542     
##    season_id     redirect_url      
##  Min.   :  107   Length:1200       
##  1st Qu.:  562   Class :character  
##  Median : 3491   Mode  :character  
##  Mean   :10602                     
##  3rd Qu.:24327                     
##  Max.   :32364                     
##  NA&#39;s   :1083                      
##                                                                          bangumi.ep_id                                                                                                                                                   bangumi.title                                                                                                                                                 bangumi.long_title                                                                                                                                            bangumi.episode_status                                                                                                                                              bangumi.follow                                                                                                                                                  bangumi.cover                                                                           bangumi.season.season_id      season.title     season.season_status   season.is_finish   season.total_count  season.newest_ep_id  season.newest_ep_index  season.season_type
##  Min.   :330566.0                                                                                                                                                Length:1200                                                                                                                                                     Length:1200                                                                                                                                                     Min.   : 2.0                                                                                                                                                    Min.   :0                                                                                                                                                       Length:1200                                                                                                                                                     Min.   :27040       Length:1200         Min.   : 2.0000     Min.   :0.0000      Min.   :-1.0000     Min.   :330566.0    Length:1200         Min.   :2.0000                  
##  1st Qu.:339391.0                                                                                                                                                Class :character                                                                                                                                                Class :character                                                                                                                                                1st Qu.: 2.0                                                                                                                                                    1st Qu.:0                                                                                                                                                       Class :character                                                                                                                                                1st Qu.:31395       Class :character    1st Qu.: 2.0000     1st Qu.:0.5000      1st Qu.:-1.0000     1st Qu.:359631.0    Class :character    1st Qu.:2.0000                  
##  Median :384953.0                                                                                                                                                Mode  :character                                                                                                                                                Mode  :character                                                                                                                                                Median : 2.0                                                                                                                                                    Median :0                                                                                                                                                       Mode  :character                                                                                                                                                Median :34041       Mode  :character    Median : 8.0000     Median :1.0000      Median : 1.0000     Median :416137.0    Mode  :character    Median :3.0000                  
##  Mean   :378549.3                                                                                                                                                NA                                                                                                                                                              NA                                                                                                                                                              Mean   : 6.0                                                                                                                                                    Mean   :0                                                                                                                                                       NA                                                                                                                                                              Mean   :34280       NA                  Mean   : 7.5714     Mean   :0.7143      Mean   : 0.7143     Mean   :391498.3    NA                  Mean   :3.1429                  
##  3rd Qu.:416009.0                                                                                                                                                NA                                                                                                                                                              NA                                                                                                                                                              3rd Qu.:10.5                                                                                                                                                    3rd Qu.:0                                                                                                                                                       NA                                                                                                                                                              3rd Qu.:38450       NA                  3rd Qu.:13.0000     3rd Qu.:1.0000      3rd Qu.: 1.0000     3rd Qu.:424143.0    NA                  3rd Qu.:3.0000                  
##  Max.   :423526.0                                                                                                                                                NA                                                                                                                                                              NA                                                                                                                                                              Max.   :13.0                                                                                                                                                    Max.   :0                                                                                                                                                       NA                                                                                                                                                              Max.   :39189       NA                  Max.   :13.0000     Max.   :1.0000      Max.   : 5.0000     Max.   :426237.0    NA                  Max.   :7.0000                  
##  NA&#39;s   :1193                                                                                                                                                    NA                                                                                                                                                              NA                                                                                                                                                              NA&#39;s   :1193                                                                                                                                                    NA&#39;s   :1193                                                                                                                                                    NA                                                                                                                                                              NA&#39;s   :1193        NA                  NA&#39;s   :1193        NA&#39;s   :1193        NA&#39;s   :1193        NA&#39;s   :1193        NA                  NA&#39;s   :1193                    
##   cheese.season_id     cheese.number     cheese.long_title      cheese.cover     cheese.update_info
##  Min.   :359         Length:1200         Length:1200         Length:1200         Length:1200       
##  1st Qu.:359         Class :character    Class :character    Class :character    Class :character  
##  Median :359         Mode  :character    Mode  :character    Mode  :character    Mode  :character  
##  Mean   :359         NA                  NA                  NA                  NA                
##  3rd Qu.:359         NA                  NA                  NA                  NA                
##  Max.   :359         NA                  NA                  NA                  NA                
##  NA&#39;s   :1199        NA                  NA                  NA                  NA</code></pre>
<p>对于数据的每一列的含义，项目中<a href="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/history&amp;toview/history.md#%E8%8E%B7%E5%8F%96%E5%85%A8%E9%83%A8%E8%A7%86%E9%A2%91%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E6%97%A7">获取全部视频历史记录（旧）</a>均有说明。不过我们首先要弄明白，我们的观看记录最早记录到什么时候？</p>
</div>
<div id="数据整理" class="section level1" number="3">
<h1><span class="header-section-number">3</span> 数据整理</h1>
<p>根据此前的 <code>summary()</code> 以及<a href="https://github.com/SocialSisterYi/bilibili-API-collect/blob/master/history&amp;toview/history.md#%E8%8E%B7%E5%8F%96%E5%85%A8%E9%83%A8%E8%A7%86%E9%A2%91%E5%8E%86%E5%8F%B2%E8%AE%B0%E5%BD%95%E6%97%A7">获取全部视频历史记录（旧）</a>中的说明。<code>duration</code> 键值为视频长度，<code>progress</code> 为视频播放进度，对于完播视频其键值为 <code>-1</code>。为了便于计算播放时长，我们将 <code>duration</code> 与 <code>progress</code> 结合输出为 <code>play_time</code> 以计算播放时间。</p>
<p>记录观看时间的 <code>view_at</code> 键值为 1634781264 这样的形式，根据经验此处应为 Unix 时间戳，使用 <code>as.POSIXct</code> 转换为 date/time 格式。之后按照每天中的时间以及星期将观看时间进行归类。同样的方法来处理 <code>pubdate</code>。</p>
<p>代表分区大类的 <code>tid</code> 键值类型为数值型，然而根据其实际意义，应与 <code>tname</code> 结合使用，通过 <code>forcats::fct_reorder</code> 根据 <code>tid</code> 对 <code>tname</code> 进行排序。</p>
<pre class="r"><code>library(&quot;lubridate&quot;)
library(&quot;forcats&quot;)

histroy_tidy_tb &lt;-
  history_tb %&gt;%
  mutate(
    tname = fct_reorder(tname, tid),
    play_time = 
      if_else(progress&lt;0, duration, progress),
    pubdate = 
      as.POSIXct(pubdate, origin = &quot;1970-01-01&quot;),
    view_at =
      as.POSIXct(view_at, origin = &quot;1970-01-01&quot;),
    date = date(view_at),
    time = round(local_time(view_at, units = &quot;hours&quot;)),
    dow = wday(view_at, week_start = 1)
  )</code></pre>
</div>
<div id="数据可视化" class="section level1" number="4">
<h1><span class="header-section-number">4</span> 数据可视化</h1>
<div id="我到底看了多久的视频" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> 我到底看了多久的视频？</h2>
<p>首先我们回答第一个问题，这段时间我到底看了多久的 B 站视频？</p>
<pre class="r"><code>total_sec &lt;- histroy_tidy_tb %&gt;% 
  summarise(
    min = min(view_at),
    max = max(view_at),
    total = sum(play_time))

total_sec</code></pre>
<pre><code>## # A tibble: 1 × 3
##   min                 max                  total
##   &lt;dttm&gt;              &lt;dttm&gt;               &lt;int&gt;
## 1 2021-09-01 19:43:49 2021-10-21 09:54:24 331559</code></pre>
<p>从 2021-09-01 19:43:49 到 2021-10-21 09:54:24 总共看视频 331559 秒！也就是92.1 小时！妈见打系列了属于是。</p>
</div>
<div id="什么时候才会看-b-站" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> 什么时候才会看 B 站？</h2>
<p>之后，我们开始探究新的问题，我都是在什么时候看的 B 站视频？我们分别对日期、一日中的时间、一周中的每天进行了可视化分析。</p>
<pre class="r"><code>library(&quot;ggplot2&quot;)
library(&quot;cowplot&quot;)</code></pre>
<pre><code>## 
## Attaching package: &#39;cowplot&#39;</code></pre>
<pre><code>## The following object is masked from &#39;package:lubridate&#39;:
## 
##     stamp</code></pre>
<pre class="r"><code>view_date_p &lt;-
  histroy_tidy_tb %&gt;%
  group_by(date) %&gt;%
  summarise(duration_sum = sum(play_time, na.rm = TRUE)/3600) %&gt;%
  ggplot(aes(x = date, y = duration_sum)) +
  geom_line() +
  scale_x_date(
    &quot;&quot;,
    date_breaks = &quot;7 day&quot;) +
  ylab(&quot;Total Play Duration\n(Hour)&quot;)

view_time_p &lt;-
  histroy_tidy_tb %&gt;%
  group_by(time) %&gt;%
  summarise(duration_mean = mean(play_time, na.rm = TRUE)/3600) %&gt;%
  ggplot(aes(x = time, y = duration_mean)) +
  geom_col() +
  scale_x_continuous(
    &quot;Time of Day&quot;,
    limits = c(0, 24)) +
  ylab(&quot;Mean Play Duration\n(Hour/day)&quot;)

view_dow_p &lt;-
  histroy_tidy_tb %&gt;%
  group_by(dow) %&gt;%
  summarise(duration_mean = mean(play_time, na.rm = TRUE)/3600) %&gt;%
  ggplot(aes(x = dow, y = duration_mean)) +
  geom_col() +
  scale_x_continuous(&quot;Day of Week&quot;) +
  ylab(&quot;Mean Play Duration\n(Hour/day)&quot;)

view_bottom_grid_p &lt;-
  plot_grid(view_time_p,
            view_dow_p,
            labels = c(&quot;B&quot;, &quot;C&quot;))

view_title_p &lt;-
  ggdraw() +
  draw_label(
    &quot;Play Duration (Hour)&quot;, 
    fontface = &quot;bold&quot;
  ) +
  theme(
    plot.margin = margin(0, 0, 0, 0)
  )

view_grid_p &lt;-
  plot_grid(
    view_date_p,
    view_bottom_grid_p,
    view_title_p,
    labels = c(&quot;A&quot;, &quot;&quot;, &quot;&quot;),
    rel_heights = c(1, 1, .1),
    nrow = 3)

view_grid_p</code></pre>
<p><img src="/post/2021-10-10-using-r-我到底在-b-站花了多长时间/index.zh-hans_files/figure-html/when_view_viz-1.png" width="672" /></p>
<p>从可视化结果来看9月23号到10月2日我看了比往常更多个B站频。此外周一周二我刷视频时间似乎更久，然而最有趣的是，我到底是个怎样的夜猫子哇，居然凌晨也不休息？？？？注意身体哇<del>少年</del>中年。</p>
</div>
<div id="我看了哪类视频" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> 我看了哪类视频？</h2>
<p>既然花费了那么久看视频，那么我到底看了什么视频呢？</p>
<pre class="r"><code>library(forcats)
library(showtext)</code></pre>
<pre><code>## Loading required package: sysfonts</code></pre>
<pre><code>## Loading required package: showtextdb</code></pre>
<pre class="r"><code>showtext_auto()

histroy_tidy_tb %&gt;% 
  select(
    tname,
    play_time
  ) %&gt;% 
  group_by(tname) %&gt;% 
  summarise(duration_sum = sum(play_time, na.rm = TRUE)/3600) %&gt;% 
  mutate(tname = fct_reorder(
    tname, duration_sum
  )) %&gt;% 
  ggplot(aes(x = tname,
             y = duration_sum)) +
  geom_col() +
  coord_flip() +
  labs(x = &quot;播放时长 （小时）&quot;,
       y = &quot;子分类&quot;) +
  theme(text = element_text(family = &quot;source-han-sans-cn&quot;))</code></pre>
<p><img src="/post/2021-10-10-using-r-我到底在-b-站花了多长时间/index.zh-hans_files/figure-html/category_viz-1.png" width="672" /></p>
<p>再来看看不同时间看视频类型有没有什么差别。按照 <code>time</code> 和 <code>tname</code> 分类，观察每天不同类型视频的时常。</p>
<pre class="r"><code>showtext_auto()

histroy_tidy_tb %&gt;% 
  group_by(time, tname) %&gt;%
  summarise(duration_mean_by_type = mean(play_time, na.rm = TRUE)/3600)  %&gt;%
  select(
    tname, time, duration_mean_by_type
  ) %&gt;% 
  ggplot(aes(x = time,
             y = duration_mean_by_type,
             fill = tname
             )) +
  geom_col()</code></pre>
<p><img src="/post/2021-10-10-using-r-我到底在-b-站花了多长时间/index.zh-hans_files/figure-html/category_time_viz-1.png" width="672" /></p>
<p>然而因为分类过于丰富了，反而看不出规律了。为了便于数据可视化，我们这里尝试将播放时长较短的类型合并，将类别播放总时间低于整体播放总时间 1% 的视频分类归为其它。</p>
<pre class="r"><code>library(&quot;colorspace&quot;)

history_type_aggregate_tb &lt;-
  histroy_tidy_tb %&gt;%
  select(tname,
         play_time) %&gt;%
  group_by(tname) %&gt;%
  summarise(duration_sum = sum(play_time, na.rm = TRUE) / 3600) %&gt;%
  mutate(percentage = duration_sum / sum(duration_sum),
         tname = as.character(tname)) %&gt;%
  mutate(type = if_else(percentage &gt;= .01, tname, &#39;other&#39;)) %&gt;%
  group_by(type) %&gt;%
  summarise(duration_sum = sum(duration_sum)) %&gt;% 
  arrange(desc(duration_sum))

DT::datatable(history_type_aggregate_tb)</code></pre>
<div id="htmlwidget-1" style="width:100%;height:auto;" class="datatables html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"filter":"none","vertical":false,"data":[["1","2","3","4","5","6","7","8","9","10","11","12","13"],["单机游戏","人文历史","搞笑","other","美食侦探","日常","美食制作","影视杂谈","数码","财经商业","社科·法律·心理","美食测评","美食记录"],[21.0811111111111,18.5225,12.1830555555556,9.47694444444445,7.18944444444444,5.52027777777778,5.10083333333333,4.53805555555556,2.06583333333333,1.89777777777778,1.54833333333333,1.53333333333333,1.44222222222222]],"container":"<table class=\"display\">\n  <thead>\n    <tr>\n      <th> <\/th>\n      <th>type<\/th>\n      <th>duration_sum<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"columnDefs":[{"className":"dt-right","targets":2},{"orderable":false,"targets":0}],"order":[],"autoWidth":false,"orderClasses":false}},"evals":[],"jsHooks":[]}</script>
<pre class="r"><code>showtext_auto()

histroy_tidy_tb %&gt;% 
  mutate(
    tname = as.character(tname),
    type = if_else(tname %in% history_type_aggregate_tb$type, 
                   tname,
                   &quot;other&quot;
    )) %&gt;% 
  group_by(time, type) %&gt;%
  summarise(duration_mean_by_type = mean(play_time, na.rm = TRUE)/3600)  %&gt;%
  select(
    type, time, duration_mean_by_type
  ) %&gt;% 
  ggplot(aes(x = time,
             y = duration_mean_by_type,
             fill = type,
             label = type
  )) +
  geom_col() +
  labs(x = &quot;时间&quot;,
       y = &quot;播放时长\n(小时)&quot;,
       fill = &quot;视频类别&quot;) +
  theme_classic() +
  scale_fill_discrete_sequential(&quot;Batlow&quot;)</code></pre>
<p><img src="/post/2021-10-10-using-r-我到底在-b-站花了多长时间/index.zh-hans_files/figure-html/tname_to_type_viz-2.png" width="672" /></p>
<p>看起来，我仍然是那个爱看别人打游戏的少年，一天中只要看 B 站，就会花时间看单机游戏。其次在凌晨和中午就比较喜欢看影视杂谈类的视频。最后到了半下午和晚上，就喜欢看美食类的节目……果然是个几百斤的孩子呢（摊手</p>
<p>文章至此，长度已经太长了，更多的分析，在接下来的文章中呈现，先把数据保存下来以后续使用。<del>这里我们把 <code>tibble</code> 对象保存为 <code>Parquet</code> 文件，这是一种通用性较高的分列式文件格式，也是 Hadoop 生态中常用的文件存储格式。具体介绍见 <a href="https://github.com/apache/arrow/tree/master/r">apache/arrow</a></del>。我们直接把数据保存在本地的 MinIO 数据库中。</p>
<pre class="r"><code>library(minio.s3)
# bucket &lt;-
#   minio.s3::put_bucket(&quot;bili-history&quot;)
s3save(histroy_tidy_tb, object = &quot;histroy_tidy_tb.Rdata&quot;, bucket = &#39;bili-history&#39;)
get_bucket(&#39;bili-history&#39;)</code></pre>
<pre><code>## Bucket: bili-history 
## 
## $Contents
## Key:            histroy_tidy_tb.Rdata 
## LastModified:   2021-10-21T03:27:53.416Z 
## ETag:           &quot;7a07c6f484da97bf7cac3fa97e898991&quot; 
## Size (B):       347773 
## Owner:          minio 
## Storage class:  STANDARD</code></pre>
<hr />
<p>欢迎通过<a href="mailto://chenhan28@gmail.com">邮箱</a>，<a href="https://weibo.com/womeimingzi11">微博</a>, <a href="https://twitter.com/chenhan1992">Twitter</a>以及<a href="https://www.zhihu.com/people/womeimingzi">知乎</a>与我联系。也欢迎关注<a href="https://blog.washman.top/">我的博客</a>。如果能对<a href="https://github.com/womeimingzi11">我的 Github</a> 感兴趣，就再欢迎不过啦！</p>
</div>
</div>

    </div>
    <div class="info post_meta">
      <time datetime=2021-10-21T00:00:00Z class="date">Thursday, October 21, 2021</time>
      
        <ul class="tags">
        
          <li> <a href="https://blog.washman.top/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90">数据分析</a> </li>
        
          <li> <a href="https://blog.washman.top/tags/analysis">Analysis</a> </li>
        
          <li> <a href="https://blog.washman.top/tags/r">R</a> </li>
        
          <li> <a href="https://blog.washman.top/tags/%E7%88%AC%E8%99%AB">爬虫</a> </li>
        
          <li> <a href="https://blog.washman.top/tags/httr">httr</a> </li>
        
        </ul>
      
      
    </div>
    <div class="clearfix"></div>
  </article>
  
    <div class="other_posts">
      
      <a href="https://blog.washman.top/post/2021-10-12-what-you-did-app/" class="prev">Using R: iOS App 背着我们干了啥？</a>
      
      
    </div>
    <aside id="comments">
    <div id="vcomments"></div>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <script type="text/javascript">
          const meta = 'nick,mail'.split(',').filter(function (item) {
              return ['nick','mail','link'].indexOf(item) > -1;
          });
          const requiredFields = 'nick,mail'.split(',').filter(function(item) {
            return ['nick', 'mail'].indexOf(item) > -1;
          })
          new Valine({
              el: '#vcomments',
              appId: 'p28b16bttr3Y0SUO2PWhuyMn-gzGzoHsz',
              appKey: 'HPGrnuJVajkgFhHjDSde7Xuc',
              placeholder: '欢迎讨论～',
              avatar: 'mm',
              pageSize: '10' || 10,
              visitor: false ,
              highlight: true ,
              recordIP: true ,
              requiredFields: requiredFields || undefined,
              meta: meta || undefined,
      });
    </script>
</aside>

  
</section>

        <a id="back_to_top" title="Go To Top" href="#">
  <span>
    <svg viewBox="0 0 24 24">
      <path fill="none" d="M0 0h24v24H0z"></path>
      <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"></path>
    </svg>
  </span>
</a>

        <footer id="footer">
  <p>
    <span>&copy; 2021 <a href="https://blog.washman.top/" title="洗衣机的博客">洗衣机的博客</a> </span>
    <span>Built with <a rel="nofollow" target="_blank" href="https://gohugo.io">Hugo</a></span>
    <span>Theme by <a rel="nofollow" target="_blank" href="https://github.com/wayjam/hugo-theme-mixedpaper">WayJam</a></span>
  </p>

  <script src="https://blog.washman.top/js/main.min.d36ef68c78feb357a5c05e0c28a47045a10fabf33345f1cb02f91d521272e329.js" integrity="sha256-0272jHj+s1elwF4MKKRwRaEPq/MzRfHLAvkdUhJy4yk=" crossorigin="anonymous" async></script>
</footer>

    </body>
</html>
