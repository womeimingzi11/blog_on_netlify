<!DOCTYPE html>
<html lang="zh-cn">
    <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="format-detection" content="telephone=no" />

  <title>
    Using R: 使用 ggplot2 绘制 RasterLayer 地图 | 洗衣机的博客
  </title>

  
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#ffffff" />

  
  <link
    rel="stylesheet"
    href="https://unpkg.com/modern-normalize@0.6.0/modern-normalize.css"
  />

  
  
  
  
  <link rel="stylesheet" href="https://blog.washman.top/style.min.bd2cee8cbd90a87d0e442d03c16f05be6e30184eb160d1d9013e70e07b8490f4.css" integrity="sha256-vSzujL2QqH0ORC0DwW8Fvm4wGE6xYNHZAT5w4HuEkPQ=" />

  
  
    
  
</head>

    <body>
        <header id="header">
  <div class="header_container">
    <h1 class="sitetitle">
      <a href="https://blog.washman.top/" title="洗衣机的博客">洗衣机的博客</a>
    </h1>
    <nav class="navbar">
      <ul>
        <li><a href="https://blog.washman.top/">Home</a></li>
        
          <li>
            <a href="/about/">
              
              <span>About Me</span>
            </a>
          </li>
        
          <li>
            <a href="/tags/">
              
              <span>Tags</span>
            </a>
          </li>
        
          <li>
            <a href="/post/">
              
              <span>Posts</span>
            </a>
          </li>
        
        <li class="hide-sm"><a href="https://blog.washman.top/index.xml" type="application/rss+xml">RSS</a></li>
      </ul>
    </nav>
  </div>
</header>

        
<section id="main">
  <article class="post content">
    <h2 class="title">Using R: 使用 ggplot2 绘制 RasterLayer 地图</h2>
    <div class="post_content">
      <p>Han (<!-- raw HTML omitted --><a href="mailto:chenhan28@gmail.com">chenhan28@gmail.com</a><!-- raw HTML omitted -->)
在最近刚刚完成的一篇 SCI 文章中，为了描述实验的采样范围，通过 ggplot2 包 (Wickham et al. 2019) 将一组 RasterLayer 绘制成为了青藏高原的地形图。考虑到使用 R 绘制地图的中文内容较少，我们进行一次回顾。</p>
<p><strong>PS 因为不是地理方面的文章/专业，所以在专业性方面有欠缺，但对于自然科学类文章中进行展示基本上是足够了。</strong></p>
<h2 id="为什么用-ggplot2-画地图">为什么用 ggplot2 画地图？</h2>
<p><strong>因为我能！（摊手</strong></p>
<p>实际上原因如下：</p>
<ol>
<li>
<p>ggplot2 是非常强大的绘图工具，配合上 ggplot2 的衍生包，这套工具链基本能满足生态学领域几乎所有的绘图需求。</p>
</li>
<li>
<p>如果对 Photoshop 这类图像处理软件熟悉，就会发现使用 ggplot2 画图，逻辑上和 PS 是非常相似的，便于快速上手和修改生成的图像——天知道把英文图改成中文图有多烦人</p>
</li>
<li>
<p>此外相比于 ArcGIS 这类软件 R 这类跨平台软件几乎可以在任何环境下完成绘图任务，甚至可以在家中的机顶盒安装 R，只不过慢到天长地久而已。</p>
</li>
<li>
<p>免费免费免费</p>
</li>
</ol>
<p>在开始之前，先来看看最终的展示效果。<strong>为了避免文章版权和数据共享问题，地图上样点均去除，仅供参考。</strong></p>
<p><img src="https://picgo-1256649726.cos.ap-chengdu.myqcloud.com/gmap.jpg" alt="Demo without points"></p>
<h2 id="什么是-rasterlayer">什么是 RasterLayer？</h2>
<p>关于 RasterLayer 的定义，在 <a href="https://rspatial.org/raster/spatial/4-rasterdata.html">Spatial Data Science (Feed the Future n.d.)</a> 中有很好的解释。</p>
<blockquote>
<p>A RasterLayer object represents single-layer (variable) raster data. A
RasterLayer object always stores a number of fundamental parameters
that describe it. These include the number of columns and rows, the
spatial extent, and the Coordinate Reference System. In addition, a
RasterLayer can store information about the file in which the raster
cell values are stored (if there is such a file). A RasterLayer can
also hold the raster cell values in memory.</p>
</blockquote>
<p>在 R 中提及的 RasterLayer 通常指的是由 sp 包 (Pebesma et al. 2019) 提供的 RasterLayer 类，每一个 RasterLayer 代表一层 raster 栅格数据，其中记录了 raster 数据的基础信息，例如行、列、空间范围、参考系。而对 RasterLayer 进行操作最常用的工具是 raster 包 (Hijmans et al. 2020)。</p>
<h2 id="数据准备">数据准备</h2>
<p>所需加载包： 1. <code>elevatr</code>(Hollister and Shah 2018)；2. <code>raster</code>； 3.<code>tidyverse</code> (Wickham and RStudio 2019)</p>
<p>具体到这一次的地图绘制中，我们需要<strong>两个</strong> RasterLayer —— 1. 作为背景层的 <code>bg_rst</code>，以及 2.用作展示地形的 <code>tp_rst</code>。那么如何获得这两个 RasterLayer 呢？<code>elevatr</code> 包提供了专门用于获取高程栅格数据的方法 <code>get_elev_raster</code>.</p>
<p>不过在获取高程数据之前，需要首先指定地图绘制矩形边界。之后方可使用 <code>get_elev_raster</code> 来获取边界范围内的高程数据，使用 <code>z</code> 参数 (zoom) 确定缩放程度。因为通过 <code>get_elev_raster</code> 获取高程 raster 的方法是获取服务器与自定义边界的最小公倍数（不准确的说法），所以需要对获取的原始 RasterLayer 再次剪切，以便得到地图绘制矩形边界内的数据。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">elevatr</span><span class="p">)</span>  <span class="c1"># Get rasterlay from AWS by `get_elev_raster` fucntion</span>
<span class="nf">library</span><span class="p">(</span><span class="n">raster</span><span class="p">)</span>  <span class="c1"># Manipulate RasterLayer object</span>
<span class="nf">library</span><span class="p">(</span><span class="n">tidyverse</span><span class="p">)</span>  <span class="c1"># Tidy is everything.</span>

<span class="c1"># Set the extent we want to plot</span>
<span class="n">ext_sample</span> <span class="o">&lt;-</span> <span class="nf">extent</span><span class="p">(</span><span class="m">70</span><span class="p">,</span> <span class="m">105</span><span class="p">,</span> <span class="m">25</span><span class="p">,</span> <span class="m">45</span><span class="p">)</span>

<span class="c1"># Preparing for getting the elevation raster data, make a blank RasterLayer,</span>
<span class="c1"># becasue the first parameter of get_elev_raster is a target Rasterlayer.</span>
<span class="n">bg_init</span> <span class="o">&lt;-</span> <span class="nf">raster</span><span class="p">(</span><span class="n">ext</span> <span class="o">=</span> <span class="n">ext_sample</span><span class="p">,</span> <span class="n">resolution</span> <span class="o">=</span> <span class="m">0.01</span><span class="p">)</span>
<span class="c1"># Get elevation raster with zoom 5, then only keep the extend we want to plot</span>
<span class="c1"># later.</span>
<span class="n">bg_rst</span> <span class="o">&lt;-</span> <span class="nf">get_elev_raster</span><span class="p">(</span><span class="n">bg_init</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="m">5</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">crop</span><span class="p">(</span><span class="n">ext_sample</span><span class="p">)</span>
</code></pre></div><p><code>bg_rst</code> 就是地图背景中灰色的辅助部分的数据就准备好了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="c1"># Let&#39;s check the detail of bg_rst, the Background RasterLayer</span>
<span class="n">bg_rst</span>
</code></pre></div><pre><code>## class      : RasterLayer 
## dimensions : 1075, 1591, 1710325  (nrow, ncol, ncell)
## resolution : 0.022, 0.0186  (x, y)
## extent     : 70.008, 105.01, 25.0029, 44.9979  (xmin, xmax, ymin, ymax)
## crs        : +proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0 
## source     : /private/var/folders/0s/pkk0623j6dgdq9yyg4d3qtq40000gn/T/RtmpUCKkKF/raster/r_tmp_2020-02-21_223346_8889_78742.grd 
## names      : layer 
## values     : -156.1392, 8006.811  (min, max)
</code></pre>
<p>随后我们需要下载青藏高原的多边形文件，这里我们选择张镱锂 (2002) 等人在《论青藏高原范围与面积》一文提供的青藏高原范围与界线地理信息系统数据。从<a href="http://www.geodoi.ac.cn/WebCn/doi.aspx?Id=135">《全球变化科学研究数据出版系统》</a>下载即可。这里我选择了 <code>DBATP.zip</code> 下载，对应的文件格式为 Shaplefile，使用 rgdal 包 (Bivand et al. 2019) 提供的 <code>readOGR</code> 方法读取其中的 <code>DBATP_Polygon.shp</code>，保存的数据类型为<code>tp_ext</code>（类型为 SpatialPolygonsDataFrame）。之后将<code>bg_rst</code> 数据按照 <code>tp_ext</code> 形状进行处理，获得符合青藏高原范围的 RasterLayer <code>tp_rst</code>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="nf">library</span><span class="p">(</span><span class="n">rgdal</span><span class="p">)</span>
<span class="c1"># Read the SpatialPolygon File from DBATP_Polygon.shp</span>
<span class="n">tp_ext</span> <span class="o">&lt;-</span> <span class="nf">readOGR</span><span class="p">(</span><span class="s">&#34;DBATP/DBATP_Polygon.shp&#34;</span><span class="p">)</span>
</code></pre></div><pre><code>## OGR data source with driver: ESRI Shapefile 
## Source: &quot;/Users/chenhan/Documents/Develop Learn/R/plotMapByGGplot/DBATP/DBATP_Polygon.shp&quot;, layer: &quot;DBATP_Polygon&quot;
## with 1 features
## It has 1 fields
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="c1"># Keep the shpae of the Tibetan Plateau</span>
<span class="n">tp_rst</span> <span class="o">&lt;-</span> <span class="nf">mask</span><span class="p">(</span><span class="n">bg_rst</span><span class="p">,</span> <span class="n">tp_ext</span><span class="p">)</span>
</code></pre></div><p>为了便于定位，我们还将在图片上绘制地标名称 <code>city_ls</code>，以及采样点位置及其类型 <code>hbt_coord</code>。</p>
<p>PS.可以根据自己的实际情况确定数据的存储类型，这里因为个人项目的实际情况，数据并没有保存成为常见的 data.freame 或者 tibble 之类的类表格形式。<strong>注意绘图过程中前后对应即可</strong>。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="c1"># Create the list of landmarks which we want to mark</span>
<span class="n">city_ls</span> <span class="o">&lt;-</span> <span class="nf">list</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">91.1</span><span class="p">,</span> <span class="m">86.925278</span><span class="p">,</span> <span class="m">101.7781</span><span class="p">),</span> <span class="n">y</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">29.65</span><span class="p">,</span> <span class="m">27.988056</span><span class="p">,</span> <span class="m">36.6169</span><span class="p">),</span> 
    <span class="n">label</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&#34;Lhasa&#34;</span><span class="p">,</span> <span class="s">&#34;Qomolangma&#34;</span><span class="p">,</span> <span class="s">&#34;Xi&#39;Ning&#34;</span><span class="p">))</span>
<span class="nf">str</span><span class="p">(</span><span class="n">city_ls</span><span class="p">)</span>
</code></pre></div><pre><code>## List of 3
##  $ x    : num [1:3] 91.1 86.9 101.8
##  $ y    : num [1:3] 29.6 28 36.6
##  $ label: chr [1:3] &quot;Lhasa&quot; &quot;Qomolangma&quot; &quot;Xi'Ning&quot;
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="c1"># Read point with latitude and longitude. This operation is not needed for</span>
<span class="c1"># everyone, actually it depends on the actual data structure.</span>
<span class="n">hbt_coord</span> <span class="o">&lt;-</span> <span class="nf">read_rds</span><span class="p">(</span><span class="s">&#34;hbt_coord.rds&#34;</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">mutate</span><span class="p">(</span><span class="n">Ecosystem</span> <span class="o">=</span> <span class="nf">ifelse</span><span class="p">(</span><span class="n">hbt</span> <span class="o">==</span> <span class="s">&#34;M&#34;</span><span class="p">,</span> 
    <span class="s">&#34;Alpine Meadow&#34;</span><span class="p">,</span> <span class="s">&#34;Alpine Steppe&#34;</span><span class="p">))</span>
<span class="nf">str</span><span class="p">(</span><span class="n">hbt_coord</span><span class="p">)</span>
</code></pre></div><pre><code>## Classes 'tbl_df', 'tbl' and 'data.frame':    432 obs. of  4 variables:
##  $ hbt      : chr  &quot;M&quot; &quot;M&quot; &quot;M&quot; &quot;M&quot; ...
##  $ lon      : num  101 101 101 100 100 ...
##  $ lat      : num  35.3 35 35 34.5 34.5 ...
##  $ Ecosystem: chr  &quot;Alpine Meadow&quot; &quot;Alpine Meadow&quot; &quot;Alpine Meadow&quot; &quot;Alpine Meadow&quot; ...
</code></pre>
<p><strong>注意</strong>，前面的操作中，我们裁剪 RasterLayer 用到了 crop 和 mask 两种操作，关于这两种操作的解释，我用一张图来解释：</p>
<p><img src="https://picgo-1256649726.cos.ap-chengdu.myqcloud.com/JPEG%E5%9B%BE%E5%83%8F-606FC26ACE54-1.jpeg" alt="Differences between crop andmask"></p>
<p>简而言之，两种操作都会得到更小的矩形图形，但是使用 mask 方法会在多边形区域外的矩形部分填充 NA 使被裁剪 RasterLayer 看起来成为多边形。</p>
<h2 id="地图绘制">地图绘制</h2>
<p>所需加载包： <code>scales</code> (Wickham, Seidel, and RStudio 2019)</p>
<p>不过在进行绘图之前，还需要对 RasterLayer 数据进行一些小的调整，以便与 <code>ggplot2</code> 的功能兼容。首先将两个 RasterLayer 转换为 data.frame 保留 xy，xy 为经纬度，应点上的值将会保留成与 RasterLayer 中 names 相同的列名，比如 <code>bg_rst</code> 转换为 data.frame 后列名就是 x, y, layer。之后我们将 layer（在此处为当前为止的海拔高度）转换数值范围，因为保留原始的数据用作后面的透明度会让整张图像灰蒙蒙。</p>
<p>不过要注意的是，正如我们前面说到的 mask 后的 RasterLayer 会将区域外的数据标记为 NA，如果直接使用 NA 绘图将会出现各种奇怪的效果，因此我们选择将 NA 数据更换为 0，将区域内的数据更换为 1，将两种值用作图像的 alpha 就会绘制出准确的青藏高原样式。</p>
<p>没看懂咋办？呆胶布！动手试试不进行 NA 转换的效果便知道了。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="c1"># scales package provide rescale function which can convert the range of numbers</span>
<span class="c1"># list to another range.</span>
<span class="nf">library</span><span class="p">(</span><span class="n">scales</span><span class="p">)</span>
</code></pre></div><pre><code>## 
## Attaching package: 'scales'

## The following object is masked from 'package:purrr':
## 
##     discard

## The following object is masked from 'package:readr':
## 
##     col_factor
</code></pre>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="c1"># First convert RasterLayer as Data.Frame with xy coordinate system.  Then</span>
<span class="c1"># rescale the elevaion to alpha, as the background part, super high alpha value</span>
<span class="c1"># is not a good idea, which range is the best? It depends by the actual. Save the</span>
<span class="c1"># alpha value with colname &#39;alpha&#39;</span>
<span class="n">bg_rst_df</span> <span class="o">&lt;-</span> <span class="nf">as.data.frame</span><span class="p">(</span><span class="n">bg_rst</span><span class="p">,</span> <span class="n">xy</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">mutate</span><span class="p">(</span><span class="n">alpha</span> <span class="o">=</span> <span class="nf">rescale</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">to</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span> 
    <span class="m">0.75</span><span class="p">)))</span>

<span class="c1"># NA will be generated by the mask function, if use NA and evelation as the alpha</span>
<span class="c1"># of Topographic figure, it will be dizzy, and for color Topographic figure</span>
<span class="c1"># please don&#39;t use the greyscale and color for the evelation simultaneously. Just</span>
<span class="c1"># use alpha to control the shape of regional shpae.</span>
<span class="n">tp_rst_df</span> <span class="o">&lt;-</span> <span class="nf">as.data.frame</span><span class="p">(</span><span class="n">tp_rst</span><span class="p">,</span> <span class="n">xy</span> <span class="o">=</span> <span class="kc">TRUE</span><span class="p">)</span> <span class="o">%&gt;%</span> <span class="nf">na.omit</span><span class="p">()</span>
</code></pre></div><p>当数据准备完毕，我们就开始图形的绘制。首先进行地形图叠加到背景地形的绘制。因为命令较多，并且均以注释的形式标注到代码中，故此不再提前讲解。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="c1"># sacle_parm as a parameter controls the sclae of the hole figure, it will be</span>
<span class="c1"># used to control the size of text, point, legend, etc. to fit the size of</span>
<span class="c1"># figure.</span>
<span class="n">scale_parm</span> <span class="o">&lt;-</span> <span class="m">2</span>
<span class="c1"># Init ggplot</span>
<span class="c1"># plot the backgroun layer, set the alpha without color will make a grey</span>
<span class="c1"># background</span>
<span class="n">gmap</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">()</span> <span class="o">+</span> 
<span class="c1"># plot the topographic layer, set alpha to keep the shape of Tibetan Plateau</span>
<span class="c1"># (TP). Color indicates the elevation.</span>
<span class="nf">geom_raster</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">bg_rst_df</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">))</span> <span class="o">+</span> 
 <span class="c1"># terrain.colors is an built-in function to generate a list of color palettes.</span>
<span class="c1"># set the legend title of evelation by name parameter.</span>
<span class="nf">geom_raster</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">tp_rst_df</span><span class="p">,</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">fill</span> <span class="o">=</span> <span class="n">layer</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">))</span> <span class="o">+</span>
 <span class="c1"># As we said before, the alphas is used to determine the shpae of TP, we don&#39;t</span>
<span class="c1"># need to show them as legends.</span>
<span class="nf">scale_fill_gradientn</span><span class="p">(</span><span class="n">colours</span> <span class="o">=</span> <span class="nf">terrain.colors</span><span class="p">(</span><span class="m">100</span><span class="p">),</span> <span class="n">name</span> <span class="o">=</span> <span class="s">&#34;Elevation (m)&#34;</span><span class="p">)</span> <span class="o">+</span>
 <span class="c1"># Project this figure as a map but not a normal figure</span>
<span class="nf">scale_alpha</span><span class="p">(</span><span class="n">guide</span> <span class="o">=</span> <span class="s">&#34;none&#34;</span><span class="p">)</span> <span class="o">+</span>
 <span class="c1"># Set preset theme makes things easire</span>
<span class="nf">coord_quickmap</span><span class="p">()</span> <span class="o">+</span>
 <span class="c1"># Set the limititions of axes. `expand` parameter will remove the gaps between</span>
<span class="nf">theme_minimal</span><span class="p">()</span> <span class="o">+</span>
 <span class="c1"># Set the titles of axis</span>
<span class="nf">scale_x_continuous</span><span class="p">(</span><span class="n">limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">70</span><span class="p">,</span> <span class="m">105</span><span class="p">),</span> <span class="n">expand</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span> <span class="o">+</span> <span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">25</span><span class="p">,</span> 
    <span class="m">45</span><span class="p">),</span> <span class="n">expand</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">))</span> <span class="o">+</span>
<span class="nf">labs</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="s">&#34;Longtitude (E)&#34;</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="s">&#34;Laitude (N)&#34;</span><span class="p">)</span> <span class="o">+</span>
 <span class="c1"># remove the background color and background grid, you know the classical</span>
<span class="c1"># ggplot&#39;s grid, don&#39;t you?</span>
<span class="nf">theme</span><span class="p">(</span><span class="n">panel.grid</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">(),</span> <span class="n">panel.background</span> <span class="o">=</span> <span class="nf">element_blank</span><span class="p">())</span> <span class="o">+</span> 
<span class="c1"># Set the size of axis and legend</span>
<span class="nf">theme</span><span class="p">(</span><span class="n">axis.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">7</span> <span class="o">*</span> <span class="n">scale_parm</span><span class="p">),</span> <span class="n">axis.text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">6</span> <span class="o">*</span> 
    <span class="n">scale_parm</span><span class="p">))</span> <span class="o">+</span> <span class="nf">theme</span><span class="p">(</span><span class="n">legend.key.width</span> <span class="o">=</span> <span class="nf">unit</span><span class="p">(</span><span class="m">0.2</span> <span class="o">*</span> <span class="n">scale_parm</span><span class="p">,</span> <span class="s">&#34;cm&#34;</span><span class="p">),</span> <span class="n">legend.key.height</span> <span class="o">=</span> <span class="nf">unit</span><span class="p">(</span><span class="m">0.5</span> <span class="o">*</span> 
    <span class="n">scale_parm</span><span class="p">,</span> <span class="s">&#34;cm&#34;</span><span class="p">),</span> <span class="n">legend.text</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">5</span> <span class="o">*</span> <span class="n">scale_parm</span><span class="p">),</span> <span class="n">legend.title</span> <span class="o">=</span> <span class="nf">element_text</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">6</span> <span class="o">*</span> 
    <span class="n">scale_parm</span><span class="p">))</span>

<span class="c1"># Preview will slow down the process of operations, I highly recommand do not</span>
<span class="c1"># preveiw the ggplot and save it as a file directly.</span>
</code></pre></div><p>上述操作完毕，如果没有意外，就可以获得一张效果尚可的底图了。但是，个人强烈建议不进行预览图像，直接进行后续的操作，因为绘制当前精度的底图需要花费较长的时间。或者可以使用 <code>ggsave</code> 方法输出为文件进行预览，这样如果效果满意，可以直接用作成品，避免预览后再次绘制效率较低。</p>
<p>随后我们再将地标为止添加到底图上。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">gmap</span> <span class="o">&lt;-</span> <span class="n">gmap</span> <span class="o">+</span>
  <span class="c1"># Add the city_ls to the main plot as landmarks.</span>
  <span class="nf">geom_text</span><span class="p">(</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="p">),</span>
    <span class="c1"># geom_text don&#39;t support the structure we used. </span>
    <span class="c1"># convert the list into data.frame, every element is used as column here.</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nf">bind_cols</span><span class="p">(</span><span class="n">city_ls</span><span class="p">),</span>
    <span class="n">size</span> <span class="o">=</span> <span class="m">2</span> <span class="o">*</span> <span class="n">scale_parm</span>
  <span class="p">)</span>
</code></pre></div><p>最后将采样点添加到底图上。注意 ⚠️ 由于版权和数据分享的原因，我将采样点的坐标设置为 0，0，故此图片上不会显示任何采样点，请根据实际情况设置！</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">gmap</span> <span class="o">&lt;-</span> <span class="n">gmap</span> <span class="o">+</span>
  <span class="c1"># Add the sample sites to the main plot as points.</span>
  <span class="c1"># Due to the copyright of my scholar article and data share policy, I won&#39;t point my sample sites to the picuture, the coordinations of point is 0,0 here.</span>
  <span class="nf">geom_point</span><span class="p">(</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="nf">aes</span><span class="p">(</span>
      <span class="c1"># x = lon,</span>
      <span class="n">x</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span>
      <span class="n">y</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span>
      <span class="c1"># y = lat,</span>
      <span class="n">col</span> <span class="o">=</span> <span class="n">Ecosystem</span><span class="p">,</span>
      <span class="n">shape</span> <span class="o">=</span> <span class="n">Ecosystem</span>
    <span class="p">),</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">hbt_coord</span><span class="p">,</span>
    <span class="c1"># Don&#39;t set the size as 0 until you don&#39;t want to see anything here.</span>
    <span class="c1"># Don&#39;t set the size as 0 until you don&#39;t want to see anything here.</span>
    <span class="c1"># Don&#39;t set the size as 0 until you don&#39;t want to see anything here.</span>
    <span class="n">size</span> <span class="o">=</span> <span class="m">0</span> <span class="o">*</span> <span class="n">scale_parm</span>
  <span class="p">)</span> <span class="o">+</span>
  <span class="c1"># Convert the color as legend class, becasuse the shape legend is legend class.</span>
  <span class="c1"># If there is no class conversion, the shape and color will be showed as two legends.</span>
  <span class="c1"># Then select colour as guides and site a larger size to make it more readable.</span>
  <span class="c1"># Don&#39;t know what&#39;s these means? Commit below code will show you everything.</span>
  <span class="nf">scale_color_discrete</span><span class="p">(</span><span class="n">guide</span> <span class="o">=</span> <span class="s">&#34;legend&#34;</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">guides</span><span class="p">(</span><span class="n">colour</span> <span class="o">=</span> <span class="nf">guide_legend</span><span class="p">(</span><span class="n">override.aes</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="m">.8</span> <span class="o">*</span> <span class="n">scale_parm</span><span class="p">)))</span>
</code></pre></div><p>如果对输出结果满意，那么可以跳过下面这一步，直接进行 <code>ggsave</code> 操作保存图像。不过在这里，保存图像之前，我们还需要修改图片的空白区域 margins 来让图像更合适一些。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="n">gmap</span> <span class="o">&lt;-</span> <span class="n">gmap</span> <span class="o">+</span>
  <span class="nf">theme</span><span class="p">(</span><span class="n">plot.margin</span> <span class="o">=</span>
          <span class="c1"># Set marigns of figure, the order of parameters is top, right, bottom, left</span>
          <span class="nf">unit</span><span class="p">(</span>
            <span class="nf">c</span><span class="p">(</span><span class="m">0</span> <span class="o">*</span> <span class="n">scale_parm</span><span class="p">,</span> <span class="m">0</span> <span class="o">*</span> <span class="n">scale_parm</span><span class="p">,</span> <span class="m">-.2</span> <span class="o">*</span> <span class="n">scale_parm</span><span class="p">,</span> <span class="m">.2</span> <span class="o">*</span> <span class="n">scale_parm</span><span class="p">),</span>
            <span class="s">&#34;cm&#34;</span>
          <span class="p">))</span>
</code></pre></div><p>最后导出图像即可。<code>ggsvae</code> 提供了丰富的参数定义输出的图像。对于需要投稿 SCI 的文章，通常 Author Guidelines 要求提供不低于 300 DPI 的图片文件。如果允许，保存为 PDF 文件会是不错的方法，毕竟通用性和文件大小都能得到很好的满足。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-r" data-lang="r"><span class="nf">ggsave</span><span class="p">(</span><span class="n">filename</span> <span class="o">=</span> <span class="s">&#34;gmap.pdf&#34;</span><span class="p">,</span> <span class="n">plot</span> <span class="o">=</span> <span class="n">gmap</span><span class="p">,</span> <span class="n">width</span> <span class="o">=</span> <span class="m">9</span> <span class="o">*</span> <span class="n">scale_parm</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="m">6.2</span> <span class="o">*</span> 
    <span class="n">scale_parm</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="s">&#34;cm&#34;</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="m">600</span><span class="p">)</span>
</code></pre></div><pre><code>## Warning: Removed 432 rows containing missing values (geom_point).
</code></pre>
<p><img src="https://picgo-1256649726.cos.ap-chengdu.myqcloud.com/gmap.jpg" alt=""></p>
<p>最后，如果有任何更好的意见和建议，换用通过任何形式与我交流。祝大家都能制作出令自己（主要是杂志）满意的作品。</p>
<h2 id="参考文献">参考文献</h2>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Bivand, Roger, Tim Keitt, Barry Rowlingson, Edzer Pebesma, Michael Sumner, Robert Hijmans, Even Rouault, Frank Warmerdam, Jeroen Ooms, and Colin Rundel. 2019. “Rgdal: Bindings for the ’Geospatial’ Data Abstraction Library.” <a href="https://CRAN.R-project.org/package=rgdal">https://CRAN.R-project.org/package=rgdal</a>.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Feed the Future. n.d. “Raster Data — R Spatial.” Blog. <em>Spatial Data Science</em>. Accessed February 19, 2020. <a href="https://rspatial.org/raster/spatial/4-rasterdata.html">https://rspatial.org/raster/spatial/4-rasterdata.html</a>.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Hijmans, Robert J., Jacob van Etten, Michael Sumner, Joe Cheng, Andrew Bevan, Roger Bivand, Lorenzo Busetto, et al. 2020. “Raster: Geographic Data Analysis and Modeling.” <a href="https://CRAN.R-project.org/package=raster">https://CRAN.R-project.org/package=raster</a>.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Hollister, Jeffrey, and Tarak Shah. 2018. “Elevatr: Access Elevation Data from Various APIs.” <a href="https://github.com/jhollist/elevatr">https://github.com/jhollist/elevatr</a>.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Pebesma, Edzer, Roger Bivand, Barry Rowlingson, Virgilio Gomez-Rubio, Robert Hijmans, Michael Sumner, Don MacQueen, Jim Lemon, Josh O’Brien, and Joseph O’Rourke. 2019. “Sp: Classes and Methods for Spatial Data.” <a href="https://CRAN.R-project.org/package=sp">https://CRAN.R-project.org/package=sp</a>.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Wickham, Hadley, Winston Chang, Lionel Henry, Thomas Lin Pedersen, Kohske Takahashi, Claus Wilke, Kara Woo, Hiroaki Yutani, and RStudio. 1.    “Ggplot2: Create Elegant Data Visualisations Using the Grammar of Graphics.” <a href="https://CRAN.R-project.org/package=ggplot2">https://CRAN.R-project.org/package=ggplot2</a>.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Wickham, Hadley, and RStudio. 2019. “Tidyverse: Easily Install and Load
the ’Tidyverse’.” <a href="https://CRAN.R-project.org/package=tidyverse">https://CRAN.R-project.org/package=tidyverse</a>.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>Wickham, Hadley, Dana Seidel, and RStudio. 2019. “Scales: Scale Functions for Visualization.” <a href="https://CRAN.R-project.org/package=scales">https://CRAN.R-project.org/package=scales</a>.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<p>张镱锂, 李炳元, and 郑度. 2002. “论青藏高原范围与面积.” <em>地理学报</em> 21 (1): 1–8. <a href="https://doi.org/10.11821/yj2002010001">https://doi.org/10.11821/yj2002010001</a>.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->

    </div>
    <div class="info post_meta">
      <time datetime=2020-02-19T00:00:00Z class="date">Wednesday, February 19, 2020</time>
      
        <ul class="tags">
        
          <li> <a href="https://blog.washman.top/tags/r">R</a> </li>
        
          <li> <a href="https://blog.washman.top/tags/ggplot2">ggplot2</a> </li>
        
          <li> <a href="https://blog.washman.top/tags/ecology">ecology</a> </li>
        
        </ul>
      
      
    </div>
    <div class="clearfix"></div>
  </article>
  
    <div class="other_posts">
      
      
      <a href="https://blog.washman.top/post/%E8%AE%BE%E5%A4%87%E7%AE%A1%E7%90%86%E5%99%A8%E4%B8%AD%E7%9A%84-mvsi-card-reader-usb-device-driver-%E6%98%AF%E4%BB%80%E4%B9%88-%E5%A6%82%E4%BD%95%E7%A7%BB%E9%99%A4%E5%85%B6%E5%8D%A0%E7%94%A8%E7%9B%98%E7%AC%A6.zh-hans/" class="next">设备管理器中的 MVSI Card Reader USB Device driver 是什么？如何移除其占用盘符？</a>
      
    </div>
    <aside id="comments">
    <div id="vcomments"></div>
    <script src="//unpkg.com/valine@latest/dist/Valine.min.js"></script>
    <script type="text/javascript">
          const meta = 'nick,mail'.split(',').filter(function (item) {
              return ['nick','mail','link'].indexOf(item) > -1;
          });
          const requiredFields = 'nick,mail'.split(',').filter(function(item) {
            return ['nick', 'mail'].indexOf(item) > -1;
          })
          new Valine({
              el: '#vcomments',
              appId: 'p28b16bttr3Y0SUO2PWhuyMn-gzGzoHsz',
              appKey: 'HPGrnuJVajkgFhHjDSde7Xuc',
              placeholder: '欢迎讨论～',
              avatar: 'mm',
              pageSize: '10' || 10,
              visitor: false ,
              highlight: true ,
              recordIP: true ,
              requiredFields: requiredFields || undefined,
              meta: meta || undefined,
      });
    </script>
</aside>

  
</section>

        <a id="back_to_top" title="Go To Top" href="#">
  <span>
    <svg viewBox="0 0 24 24">
      <path fill="none" d="M0 0h24v24H0z"></path>
      <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"></path>
    </svg>
  </span>
</a>

        <footer id="footer">
  <p>
    <span>&copy; 2021 <a href="https://blog.washman.top/" title="洗衣机的博客">洗衣机的博客</a> </span>
    <span>Built with <a rel="nofollow" target="_blank" href="https://gohugo.io">Hugo</a></span>
    <span>Theme by <a rel="nofollow" target="_blank" href="https://github.com/wayjam/hugo-theme-mixedpaper">WayJam</a></span>
  </p>

  <script src="https://blog.washman.top/js/main.min.d36ef68c78feb357a5c05e0c28a47045a10fabf33345f1cb02f91d521272e329.js" integrity="sha256-0272jHj+s1elwF4MKKRwRaEPq/MzRfHLAvkdUhJy4yk=" crossorigin="anonymous" async></script>
</footer>

    </body>
</html>
